// fchain v1.0.0 
// (c) 2013 Sergey Melnikov 

// fchain may be freely distributed under the MIT license


(function(){"use strict";function t(t,i){return Math.round(t+Math.random()*(i-t))}var i=this,e=Object.create||function(t){function i(){}return i.prototype=t,new i},n=function(){var t,i,s=this instanceof n?this:e(n.prototype);for(s.reset(),t=0,i=arguments.length;i>t;t++)s.add(arguments[t]);return s};n.prototype={length:0,add:function(t,i){if(i||(i=this._defaultTime),"function"!=typeof t)throw"FChain add: not a function";return Array.prototype.push.call(this,n.createLink(t,i)),null==this._next&&(this._next=this.length-1),this._next===this.length-1&&this.restartTimer(),this},addAt:function(t,i,e){if(0>t||t>=this.length)throw"FChain addAt: index out of bounds";Array.prototype.splice.call(this,t,0,n.createLink(i,e))},clear:function(){for(var t=0,i=this.length;i>t;t++)delete this[t];return this.length=0,this.reset()},elapsed:function(){return this._timerData?this._timerData.time-this.remaining():void 0},first:function(){return this.moveTo(0)},isTimerPaused:function(){return this._timerPaused},isTimerRunning:function(){return null!=this._timerData},restartTimer:function(){return this.setNext(this._next)},last:function(){return this.moveTo(this.length-1)},loop:function(t){return this._looping=null==t?!0:t,this._looping&&null===this._next&&(this._next=0,this.scheduleNext(this[0].time)),this},moveNextDown:function(){return this.setNext(null!=this._next?this._next-1:this.length-1)},moveNextUp:function(){return this.setNext(this._next+1)},moveTo:function(t){return this.runAt(t),this.setNext(t+1),this},next:function(){return null!==this._next&&(this.runNext(),this.moveNextUp()),this},nextIndex:function(){return this._next},pauseTimer:function(){return!this._timerPaused&&this.isTimerRunning()&&(this._remaining=this.remaining(),this.stopTimer(),this._timerPaused=!0),this},previous:function(){var t;return(null===this._next||this._next>1||this._looping)&&(null!==this._last&&this.moveNextDown(),t=this._next-1,t=this._looping&&0>t?this.length-1:t,this.runAt(t)),this},random:function(){return this.moveTo(t(0,this.length-1))},refresh:function(){for(var t=0,i=0,e=this.length;;){if(!this[t])break;i+=1,t++}return this.length=i,this._next>=i-1?this._next=null:null===this._next&&i>e&&(this._next=e),this[this._next]&&this.scheduleNext(this[this._next].time-(this.elapsed()||0)),this},resumeTimer:function(){return this._timerPaused&&this.scheduleNext(this._remaining>=0?this._remaining:0),this},remove:function(t){for(var i=0,e=this.length;e>i;i++)this[i].fn===t&&(this.removeAt(i),i--,e--);return this},removeAt:function(t){if(!(t>=0&&this.length>t))throw"FChain: Index is out of bounds";for(var i=t+1,e=this.length;e>i;i++)this[i-1]=this[i];return this.length--,delete this[this.length],this._next>t?this._next--:this._next===t&&this._next===this.length&&(this._next=null),this},remaining:function(){return this._timerData?this._timerData.time-(new Date-this._timerData.ran):void 0},reset:function(){return this.stopTimer(),this._next=0,this._last=null,this._timerPaused=!1,this._timerData=null,this._started=!1,this._defaultTime=null,this.length>0&&this.setNext(0),this},runAt:function(t){return this[t]&&(this[t].fn(),this._last=t),this},runNext:function(){return null===this._next?this:this.runAt(this._next)},scheduleNext:function(t){var i=this;this.stopTimer(),this._timerData=null==t?null:{time:t,ran:new Date,id:setTimeout(function(){i.next()},t)},this._timerPaused=!1,this._remaining=null},setNext:function(t){return 0>t?t=this._looping?this.length-1:0:t>=this.length&&(t=this._looping?0:null),this[t]&&this[t].time?this.scheduleNext(this[t].time):this.stopTimer(),this._next=t,this},setNextRandom:function(){return this.setNext(t(0,this.length-1))},scaleTime:function(t){for(var i=0,e=this.length;e>i;i++)this[i].time&&(this[i].time*=t);return this._timerPaused||null===this._timerData?this._remaining*=t:(this.pauseTimer(),this._remaining*=t,this.resumeTimer()),this},setTime:function(t){this._defaultTime=t;for(var i=0,e=this.length;e>i;i++)this[i].time=t;return this[this._next]&&this.scheduleNext(this[this._next].time),this},setTimeFor:function(t,i){return this[t].time=i,t===this._next&&this.scheduleNext(this[t].time),this},stopTimer:function(){return this._timerData&&this._timerData.id&&clearTimeout(this._timerData.id),this._timerData=null,this._timerPaused=!1,this},_last:null,_looping:null,_next:null,_timerData:null,_timerPaused:null,_remaining:null,_started:null,_defaultTime:null,splice:function(){throw"FChain: splice Not Implemented"}},n.prototype.constructor=n,n.createLink=function(t,i){var e=Object.create?Object.create(null):{};return e.fn=t,e.time=i,e},"undefined"!=typeof exports?module.exports=exports=n:i.FChain=n}).call(this);